<!DOCTYPE html><html lang="zh-cn,en,default"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> AVPlayer使用 · winter</title><meta name="description" content="AVPlayer使用 - 廖文韬"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="https://winterliao.github.io/atom.xml" title="winter"></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">winter</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>主页</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>归档</p></a><ul class="shortcut-icons"><a href="https://github.com/winterLiao" target="_blank"><img src="/images/github.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">AVPlayer使用</h1><div class="post-info">2018年8月6日</div><div class="post-content"><p>功能最全、自定义最高的播放器，也是使用最多得。使用起来较为复杂些。需导入AVKit控件（import AVKit）</p>
<h3 id="相关参数"><a href="#相关参数" class="headerlink" title="相关参数"></a>相关参数</h3><ul>
<li>AVPlayer: 负责控制播放器的播放，暂停等操作</li>
<li>AVAsset:获取多媒体信息的抽象类，不能直接使用</li>
<li>AVURLAsset: AVAsset 的一个子类，使用 URL 进行实例化，实例化对象包换 URL 对应视频资源的所有信息。</li>
<li>AVPlayerItem: 管理媒体资源对象，提供播放数据源</li>
<li>AVPlayerLayer: 负责显示视频，如果没有添加该类，只有声音没有画面</li>
</ul>
<h4 id="下载demo"><a href="#下载demo" class="headerlink" title="下载demo"></a>下载demo</h4><p><img src="http://ok841h9gr.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-08-06%20%E4%B8%8B%E5%8D%886.05.50.png" alt="AVPlayer"><br><a href="https://github.com/winterLiao/VideoPlayerDemo">swift视频播放器使用</a></p>
<h3 id="基本播放"><a href="#基本播放" class="headerlink" title="基本播放"></a>基本播放</h3><p>播放设置<br><figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line"><span class="comment">//创建媒体资源管理对象</span></div><div class="line">self<span class="selector-class">.palyerItem</span> = AVPlayerItem(url: NSURL(string: urlString)! as URL)</div><div class="line"><span class="comment">//创建ACplayer：负责视频播放</span></div><div class="line">self<span class="selector-class">.player</span> = AVPlayer.init(playerItem: self.palyerItem)</div><div class="line">self<span class="selector-class">.player</span><span class="selector-class">.rate</span> = <span class="number">1.0</span><span class="comment">//播放速度 播放前设置</span></div><div class="line"><span class="comment">//创建显示视频的图层</span></div><div class="line">let playerLayer = AVPlayerLayer.init(player: self.player)</div><div class="line">playerLayer<span class="selector-class">.videoGravity</span> = <span class="selector-class">.resizeAspect</span></div><div class="line">playerLayer<span class="selector-class">.frame</span> = self<span class="selector-class">.view</span><span class="selector-class">.bounds</span></div><div class="line">self<span class="selector-class">.view</span><span class="selector-class">.layer</span> .addSublayer(playerLayer)</div><div class="line"><span class="comment">//播放</span></div><div class="line">self<span class="selector-class">.player</span><span class="selector-class">.play</span>()</div></pre></td></tr></table></figure></p>
<p>播放暂停<br><figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line">func pauseButtonSelected(sender:UIButton)  &#123;</div><div class="line">sender<span class="selector-class">.isSelected</span> = !sender<span class="selector-class">.isSelected</span></div><div class="line"><span class="keyword">if</span> sender.isSelected&#123;</div><div class="line">self<span class="selector-class">.player</span><span class="selector-class">.pause</span>()</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">self<span class="selector-class">.player</span><span class="selector-class">.play</span>()</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="观察AVPlayerItem属性-观察播放状态、缓存情况等"><a href="#观察AVPlayerItem属性-观察播放状态、缓存情况等" class="headerlink" title="观察AVPlayerItem属性(观察播放状态、缓存情况等)"></a>观察AVPlayerItem属性(观察播放状态、缓存情况等)</h3><h4 id="当前播放状态"><a href="#当前播放状态" class="headerlink" title="当前播放状态"></a>当前播放状态</h4><p>KVO观察当前的播放状态<br><figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line">self<span class="selector-class">.palyerItem</span><span class="selector-class">.addObserver</span>(self, forKeyPath: <span class="string">"status"</span>, options: <span class="selector-class">.new</span>, context: nil)</div></pre></td></tr></table></figure></p>
<p>一共有三种播放状态，准备播放、播放失败、未知。<br><figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">observeValue</span><span class="params">(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?)</span></span> &#123;</div><div class="line"><span class="keyword">if</span> keyPath == <span class="string">"status"</span> &#123;</div><div class="line"><span class="keyword">switch</span> <span class="keyword">self</span>.palyerItem.status&#123;</div><div class="line"><span class="keyword">case</span> .readyToPlay:</div><div class="line"><span class="comment">//准备播放</span></div><div class="line"><span class="keyword">self</span>.play()</div><div class="line"><span class="keyword">case</span> .failed:</div><div class="line"><span class="comment">//播放失败</span></div><div class="line"><span class="built_in">print</span>(<span class="string">"failed"</span>)</div><div class="line"><span class="keyword">case</span>.unknown:</div><div class="line"><span class="comment">//未知情况</span></div><div class="line"><span class="built_in">print</span>(<span class="string">"unkonwn"</span>)</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="播放时间与总时间"><a href="#播放时间与总时间" class="headerlink" title="播放时间与总时间"></a>播放时间与总时间</h4><p>处理时间，有一个结构体CMTime<br><figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span>&#123;</div><div class="line"><span class="built_in">CMTimeValue</span>    value;     <span class="comment">// 帧数</span></div><div class="line"><span class="built_in">CMTimeScale</span>    timescale;  <span class="comment">// 帧率</span></div><div class="line"><span class="built_in">CMTimeFlags</span>    flags;        </div><div class="line"><span class="built_in">CMTimeEpoch</span>    epoch;    </div><div class="line">&#125; <span class="built_in">CMTime</span>;</div></pre></td></tr></table></figure></p>
<p>视频总时间<br><figure class="highlight lasso"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> totalTime = CMTimeGetSeconds((<span class="built_in">self</span>?.player.currentItem?.<span class="built_in">duration</span>)!)</div></pre></td></tr></table></figure></p>
<p>当前播放时间<br><figure class="highlight lasso"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> currentTime = <span class="built_in">self</span>.playItem.currentTime.value/<span class="built_in">self</span>.playItem.currentTime.timescale;</div></pre></td></tr></table></figure></p>
<h5 id="实时的获取播放时长和控制进度条"><a href="#实时的获取播放时长和控制进度条" class="headerlink" title="实时的获取播放时长和控制进度条"></a>实时的获取播放时长和控制进度条</h5><figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="keyword">self</span>.player.addPeriodicTimeObserver(forInterval: <span class="built_in">CMTimeMake</span>(<span class="number">1</span>, <span class="number">1</span>), queue: DispatchQueue.main) &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>](time) <span class="keyword">in</span></div><div class="line"><span class="comment">//当前正在播放的时间</span></div><div class="line">let loadTime = <span class="built_in">CMTimeGetSeconds</span>(time)</div><div class="line"><span class="comment">//视频总时间</span></div><div class="line">let totalTime = <span class="built_in">CMTimeGetSeconds</span>((<span class="keyword">self</span>?.player.currentItem?.duration)!)</div><div class="line"><span class="comment">//播放进度设置</span></div><div class="line"><span class="keyword">self</span>?.slider.value = Float(loadTime/totalTime)</div><div class="line"><span class="comment">//播放的时间（changeTimeFormat方法是转格式的）</span></div><div class="line"><span class="keyword">self</span>?.loadTimeLabel.text = <span class="keyword">self</span>?.changeTimeFormat(timeInterval: loadTime)</div><div class="line"><span class="comment">//总时间</span></div><div class="line"><span class="keyword">self</span>?.totalTimeLabel.text =<span class="keyword">self</span>?.changeTimeFormat(timeInterval:<span class="built_in">CMTimeGetSeconds</span>((<span class="keyword">self</span>?.player.currentItem?.duraton)!))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="播放缓存"><a href="#播放缓存" class="headerlink" title="播放缓存"></a>播放缓存</h3><p>与播放缓存相关的观测属性</p>
<ul>
<li>loadedTimeRanges 缓存区间，可用来获取缓存了多少</li>
<li>playbackBufferEmpty 缓存不够了 自动暂停播放</li>
<li>playbackLikelyToKeepUp 缓存好了 手动播放<figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line">self<span class="selector-class">.palyerItem</span><span class="selector-class">.addObserver</span>(self, forKeyPath: <span class="string">"loadedTimeRanges"</span>, options: <span class="selector-class">.new</span>, context: nil)</div><div class="line">self<span class="selector-class">.palyerItem</span><span class="selector-class">.addObserver</span>(self, forKeyPath: <span class="string">"playbackBufferEmpty"</span>, options: <span class="selector-class">.new</span>, context: nil)</div><div class="line">self<span class="selector-class">.palyerItem</span><span class="selector-class">.addObserver</span>(self, forKeyPath:<span class="string">"playbackLikelyToKeepUp"</span>, options: <span class="selector-class">.new</span>,context:nil)</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">observeValue</span><span class="params">(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?)</span></span> &#123;</div><div class="line"><span class="keyword">if</span> keyPath == <span class="string">"status"</span> &#123;</div><div class="line"><span class="keyword">switch</span> <span class="keyword">self</span>.palyerItem.status&#123;</div><div class="line"><span class="keyword">case</span> .readyToPlay:</div><div class="line"><span class="keyword">self</span>.play()</div><div class="line"><span class="keyword">case</span> .failed:</div><div class="line"><span class="built_in">print</span>(<span class="string">"failed"</span>)</div><div class="line"><span class="keyword">case</span>.unknown:</div><div class="line"><span class="built_in">print</span>(<span class="string">"unkonwn"</span>)</div><div class="line">&#125;</div><div class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> keyPath == <span class="string">"loadedTimeRanges"</span>&#123;</div><div class="line"><span class="keyword">let</span> loadTimeArray = <span class="keyword">self</span>.palyerItem.loadedTimeRanges</div><div class="line"><span class="comment">//获取最新缓存的区间</span></div><div class="line"><span class="keyword">let</span> newTimeRange : <span class="type">CMTimeRange</span> = loadTimeArray.first <span class="keyword">as</span>! <span class="type">CMTimeRange</span></div><div class="line"><span class="keyword">let</span> startSeconds = <span class="type">CMTimeGetSeconds</span>(newTimeRange.start);</div><div class="line"><span class="keyword">let</span> durationSeconds = <span class="type">CMTimeGetSeconds</span>(newTimeRange.duration);</div><div class="line"><span class="keyword">let</span> totalBuffer = startSeconds + durationSeconds;<span class="comment">//缓冲总长度</span></div><div class="line"><span class="built_in">print</span>(<span class="string">"当前缓冲时间：%f"</span>,totalBuffer)</div><div class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> keyPath == <span class="string">"playbackBufferEmpty"</span>&#123;</div><div class="line"><span class="built_in">print</span>(<span class="string">"正在缓存视频请稍等"</span>)</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> keyPath == <span class="string">"playbackLikelyToKeepUp"</span>&#123;</div><div class="line"><span class="built_in">print</span>(<span class="string">"缓存好了继续播放"</span>)</div><div class="line"><span class="keyword">self</span>.player.play()</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>要记得移除观察,而且这里是self.palyerItem，不要搞错了<br><figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line">self<span class="selector-class">.palyerItem</span><span class="selector-class">.removeObserver</span>(self, forKeyPath: <span class="string">"status"</span>, context: nil)</div><div class="line">self<span class="selector-class">.palyerItem</span><span class="selector-class">.removeObserver</span>(self, forKeyPath: <span class="string">"loadedTimeRanges"</span>, context: nil)</div><div class="line">self<span class="selector-class">.palyerItem</span><span class="selector-class">.removeObserver</span>(self, forKeyPath: <span class="string">"playbackBufferEmpty"</span>, context: nil)</div><div class="line">self<span class="selector-class">.palyerItem</span><span class="selector-class">.removeObserver</span>(self,forKeyPath: <span class="string">"playbackLikelyToKeepUp"</span>, context: nil)</div><div class="line">NotificationCenter<span class="selector-class">.default</span><span class="selector-class">.removeObserver</span>(self)</div></pre></td></tr></table></figure></p>
<h3 id="AVplayer常用相关通知"><a href="#AVplayer常用相关通知" class="headerlink" title="AVplayer常用相关通知"></a>AVplayer常用相关通知</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="comment">//音频中断通知</span></div><div class="line"><span class="built_in">AVAudioSessionInterruptionNotification</span></div><div class="line"><span class="comment">//音频线路改变（耳机插入、拔出）</span></div><div class="line"><span class="built_in">AVAudioSessionSilenceSecondaryAudioHintNotification</span></div><div class="line"><span class="comment">//媒体服务器终止、重启</span></div><div class="line"><span class="built_in">AVAudioSessionMediaServicesWereLostNotification</span></div><div class="line"><span class="built_in">AVAudioSessionMediaServicesWereResetNotification</span></div><div class="line"><span class="comment">//其他app的音频开始播放或者停止时</span></div><div class="line"><span class="built_in">AVAudioSessionSilenceSecondaryAudioHintNotification</span></div></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="comment">//播放结束</span></div><div class="line"><span class="built_in">AVPlayerItemDidPlayToEndTimeNotification</span>   </div><div class="line"><span class="comment">//进行跳转</span></div><div class="line"><span class="built_in">AVPlayerItemTimeJumpedNotification</span>           </div><div class="line"><span class="comment">//异常中断通知</span></div><div class="line"><span class="built_in">AVPlayerItemPlaybackStalledNotification</span>      </div><div class="line"><span class="comment">//播放失败</span></div><div class="line"><span class="built_in">AVPlayerItemFailedToPlayToEndTimeNotification</span></div></pre></td></tr></table></figure>
<p>使用AVPlayerItemDidPlayToEndTime通知<br><figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line">NotificationCenter<span class="selector-class">.default</span><span class="selector-class">.addObserver</span>(self, selector: #selector(playToEndTime), name: NSNotification<span class="selector-class">.Name</span><span class="selector-class">.AVPlayerItemDidPlayToEndTime</span>, <span class="selector-tag">object</span>: nil)</div><div class="line"></div><div class="line">@objc func playToEndTime()&#123;</div><div class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">"播放完成"</span>)</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</div></article></div><div id="disqus_thread"></div></div><script>var disqus_shortname = 'Winter';
var disqus_identifier = '2018/08/06/AVPlayer使用/';
var disqus_title = 'AVPlayer使用';
var disqus_url = 'https://winterliao.github.io/2018/08/06/AVPlayer使用/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//Winter.disqus.com/count.js" async></script></main><footer class="footer-container"><div class="paginator"><a href="/2018/08/06/Swift视频播放器/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 - 2018 <a href="https://winterliao.github.io">廖文韬</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"Winter",'auto');ga('send','pageview');</script></body></html>